name: Build macOS App (C++ Qt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # 该项目可能包含子模块

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.*' # 建议使用 Qt 6
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'

      - name: Install System Dependencies
        run: |
          # 该项目依赖 OpenCV 和 FFmpeg
          brew install opencv ffmpeg pkg-config

      - name: Configure and Build
        run: |
          # 建立构建目录
          mkdir build
          cd build
          
          # 使用 CMake 进行配置
          # 注意：如果根目录没有 CMakeLists.txt，可能需要进入 QtProject 目录
          cmake .. -DCMAKE_PREFIX_PATH=$(brew --prefix qt)/lib/cmake
          
          # 编译
          make -j$(sysctl -n hw.ncpu)

      - name: Package App (macdeployqt)
        run: |
          # 找到生成的 .app 文件并进行依赖打包
          # 假设生成在 build/bin/ 或 build/ 目录下
          APP_PATH=$(find build -name "*.app" -maxdepth 2)
          echo "Found App: $APP_PATH"
          
          # 使用 Qt 自带工具将所有库打包进 .app
          macdeployqt "$APP_PATH" -dmg -always-overwrite

      - name: Rename and Upload
        run: |
          DMG_FILE=$(find build -name "*.dmg")
          mv "$DMG_FILE" VideoSimiliCleaner_macOS.dmg

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoSimiliCleaner-macOS
          path: VideoSimiliCleaner_macOS.dmg
